---
interface Props {
  perPage?: number;
  taxonId?: number;
  searchType?: 'general' | 'species';
}

const { perPage = 5, taxonId, searchType = 'general' } = Astro.props;
---

<div class="inaturalist-container">
  <input type="text" id="search-input" placeholder={searchType === 'species' ? "Search species..." : "Search observations..."}>
  <button id="search-button">Search</button>
  <div id="inaturalist-data" data-per-page={perPage} data-taxon-id={taxonId} data-search-type={searchType}>
    Loading iNaturalist data...
  </div>
</div>

<script>
  interface Observation {
    id: number;
    species_guess: string;
    observed_on: string;
    photos: { url: string; large_url: string }[];
  }

  const container = document.getElementById('inaturalist-data');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchButton = document.getElementById('search-button');

  if (container && searchInput && searchButton) {
    const perPage = container.dataset.perPage || '5';
    const taxonId = container.dataset.taxonId;
    const searchType = container.dataset.searchType || 'general';

    async function fetchINaturalistData(query: string = '') {
      try {
        let url = `https://api.inaturalist.org/v1/observations?per_page=${perPage}`;
        if (taxonId) {
          url += `&taxon_id=${taxonId}`;
        }
        if (query) {
          if (searchType === 'species') {
            url += `&taxon_name=${encodeURIComponent(query)}`;
          } else {
            url += `&q=${encodeURIComponent(query)}`;
          }
        }
        const response = await fetch(url);
        const data = await response.json();
        
        container.innerHTML = ''; // Clear loading message
        
        if (data.results.length === 0) {
          container.innerHTML = 'No results found.';
          return;
        }

        const grid = document.createElement('div');
        grid.className = 'observation-grid';

        data.results.forEach((observation: Observation) => {
          const observationElement = document.createElement('div');
          observationElement.className = 'observation-item';
          observationElement.innerHTML = `
            <a href="${observation.photos[0]?.large_url || '#'}" target="_blank">
              <img src="${observation.photos[0]?.url || ''}" alt="${observation.species_guess}" loading="lazy">
            </a>
            <div class="observation-info">
              <h3>${observation.species_guess}</h3>
              <p>Observed on: ${new Date(observation.observed_on).toLocaleDateString()}</p>
            </div>
          `;
          grid.appendChild(observationElement);
        });

        container.appendChild(grid);
      } catch (error) {
        console.error('Error fetching iNaturalist data:', error);
        container.innerHTML = 'Error loading iNaturalist data.';
      }
    }

    searchButton.addEventListener('click', () => {
      fetchINaturalistData(searchInput.value);
    });

    searchInput.addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        fetchINaturalistData(searchInput.value);
      }
    });

    // Initial load
    fetchINaturalistData();
  } else {
    console.error('Could not find necessary elements for iNaturalist data');
  }
</script>

<style>
  .inaturalist-container {
    margin-bottom: 20px;
  }
  #search-input {
    padding: 5px;
    margin-right: 10px;
  }
  #search-button {
    padding: 5px 10px;
  }
  .observation-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  .observation-item {
    border: 1px solid #ddd;
    border-radius: 5px;
    overflow: hidden;
  }
  .observation-item img {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }
  .observation-info {
    padding: 10px;
  }
  .observation-info h3 {
    margin: 0;
    font-size: 1em;
  }
  .observation-info p {
    margin: 5px 0 0;
    font-size: 0.8em;
  }
</style>

document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("inaturalist-data"),d=document.getElementById("search-input"),f=document.getElementById("search-button"),s=document.getElementById("image-modal"),y=document.getElementById("modal-image"),g=document.getElementById("modal-caption"),m=document.getElementById("modal-thumbnails"),b=document.getElementsByClassName("close")[0],v=document.querySelector(".prev"),E=document.querySelector(".next");let c=0,u=0,r=[];if(n&&d&&f&&s&&y&&g&&m&&b&&v&&E){let _=function(e){return e.replace("square","large")},p=function(e,t){if(e>=0&&e<r.length){const o=r[e];if(t>=0&&t<o.photos.length){const a=o.photos[t].url;y.src=_(a);const i=o.species_guess||o.taxon?.preferred_common_name||o.taxon?.name||"Unknown Species";g&&(g.innerHTML=`${i}<br>Observed on: ${new Date(o.observed_on).toLocaleDateString()}`),c=e,u=t,k(o)}}},k=function(e){m&&(m.innerHTML="",e.photos.forEach((t,o)=>{const a=document.createElement("img");a.src=t.url,a.alt=`Thumbnail ${o+1}`,a.className=o===u?"modal-thumbnail active":"modal-thumbnail",a.addEventListener("click",()=>p(c,o)),m.appendChild(a)}))};const B=n.dataset.perPage||"5",L=n.dataset.taxonId,w=n.dataset.searchType||"general";async function I(e){if(!e.trim()){n&&(n.innerHTML="Please enter a search term.");return}n&&(n.innerHTML="Loading...");try{let t=`https://api.inaturalist.org/v1/observations?per_page=${B}&order=desc&order_by=created_at`;L&&(t+=`&taxon_id=${L}`),w==="species"?t+=`&taxon_name=${encodeURIComponent(e)}`:t+=`&q=${encodeURIComponent(e)}`;const a=await(await fetch(t)).json();if(a.results.length===0){n&&(n.innerHTML="No results found.");return}r=a.results;const i=document.createElement("div");i.className="observation-grid",r.forEach((l,N)=>{const T=l.species_guess||l.taxon?.preferred_common_name||l.taxon?.name||"Unknown Species",h=document.createElement("div");h.className="observation-item";const $=l.photos[0]?.url||"";h.innerHTML=`
              <img src="${$}" alt="${T}" loading="lazy" class="thumbnail">
              <div class="observation-info">
                <h3>${T}</h3>
                <p>Observed on: ${new Date(l.observed_on).toLocaleDateString()}</p>
              </div>
            `,i.appendChild(h),h.querySelector(".thumbnail").addEventListener("click",()=>{s&&(s.style.display="block",p(N,0))})}),n&&(n.innerHTML="",n.appendChild(i))}catch(t){console.error("Error fetching iNaturalist data:",t),n&&(n.innerHTML="Error loading iNaturalist data. Please try again.")}}f.addEventListener("click",()=>{I(d.value)}),d.addEventListener("keypress",e=>{e.key==="Enter"&&I(d.value)}),b.onclick=function(){s&&(s.style.display="none")},v.onclick=function(){const e=r[c],t=(u-1+e.photos.length)%e.photos.length;p(c,t)},E.onclick=function(){const e=r[c],t=(u+1)%e.photos.length;p(c,t)},window.onclick=function(e){e.target==s&&(s.style.display="none")}}else console.error("Could not find necessary elements for iNaturalist data")});

document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("inaturalist-data"),u=document.getElementById("search-input"),y=document.getElementById("search-button"),r=document.getElementById("image-modal"),b=document.getElementById("modal-image"),g=document.getElementById("modal-caption"),p=document.getElementById("modal-wiki-link"),h=document.getElementById("modal-thumbnails"),v=document.getElementsByClassName("close")[0],E=document.querySelector(".prev"),L=document.querySelector(".next");let a=0,c=0,i=[];if(t&&u&&y&&r&&b&&g&&p&&h&&v&&E&&L){let _=function(e){return e.replace("square","large")},l=function(e,o){if(e>=0&&e<i.length){const n=i[e];if(o>=0&&o<n.photos.length){const s=n.photos[o].url;b.src=_(s);const d=n.species_guess||n.taxon?.preferred_common_name||n.taxon?.name||"Unknown Species";g&&(g.innerHTML=`${d}<br>Observed on: ${new Date(n.observed_on).toLocaleDateString()}`),p&&(n.taxon?.wikipedia_url?p.innerHTML=`<a href="${n.taxon.wikipedia_url}" target="_blank" rel="noopener noreferrer">Learn more on Wikipedia</a>`:p.innerHTML=""),a=e,c=o,w(n)}}},w=function(e){h&&(h.innerHTML="",e.photos.forEach((o,n)=>{const s=document.createElement("img");s.src=o.url,s.alt=`Thumbnail ${n+1}`,s.className=n===c?"modal-thumbnail active":"modal-thumbnail",s.addEventListener("click",()=>l(a,n)),h.appendChild(s)}))},B=function(){const e=i[a];c<e.photos.length-1?l(a,c+1):a<i.length-1&&l(a+1,0)},M=function(){if(c>0)l(a,c-1);else if(a>0){const e=i[a-1];l(a-1,e.photos.length-1)}};const N=t.dataset.perPage||"5",k=t.dataset.taxonId,$=t.dataset.searchType||"general";async function I(e){if(!e.trim()){t&&(t.innerHTML="Please enter a search term.");return}t&&(t.innerHTML="Loading...");try{let o=`https://api.inaturalist.org/v1/observations?per_page=${N}&order=desc&order_by=created_at&photos=true`;k&&(o+=`&taxon_id=${k}`),$==="species"?o+=`&taxon_name=${encodeURIComponent(e)}`:o+=`&q=${encodeURIComponent(e)}`;const s=await(await fetch(o)).json();if(s.results.length===0){t&&(t.innerHTML="No results found.");return}i=s.results;const d=document.createElement("div");d.className="observation-grid",i.forEach((m,H)=>{const T=m.species_guess||m.taxon?.preferred_common_name||m.taxon?.name||"Unknown Species",f=document.createElement("div");f.className="observation-item";const C=m.photos[0]?.url||"";f.innerHTML=`
              <img src="${C}" alt="${T}" loading="lazy" class="thumbnail">
              <div class="observation-info">
                <h3>${T}</h3>
                <p>Observed on: ${new Date(m.observed_on).toLocaleDateString()}</p>
              </div>
            `,d.appendChild(f),f.querySelector(".thumbnail").addEventListener("click",()=>{r&&(r.style.display="block",l(H,0))})}),t&&(t.innerHTML="",t.appendChild(d))}catch(o){console.error("Error fetching iNaturalist data:",o),t&&(t.innerHTML="Error loading iNaturalist data. Please try again.")}}y.addEventListener("click",()=>{I(u.value)}),u.addEventListener("keypress",e=>{e.key==="Enter"&&I(u.value)}),v.onclick=function(){r&&(r.style.display="none")},E.onclick=M,L.onclick=B,window.onclick=function(e){e.target==r&&(r.style.display="none")}}else console.error("Could not find necessary elements for iNaturalist data")});

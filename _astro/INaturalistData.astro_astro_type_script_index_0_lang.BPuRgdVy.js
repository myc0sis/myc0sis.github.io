document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("inaturalist-data"),g=document.getElementById("search-input"),E=document.getElementById("search-button"),l=document.getElementById("image-modal"),d=document.getElementById("wiki-modal"),L=document.getElementById("modal-image"),y=document.getElementById("modal-caption"),p=document.getElementById("modal-wiki-link"),f=document.getElementById("modal-thumbnails"),h=document.getElementById("wiki-content"),b=document.getElementsByClassName("close"),v=document.querySelector(".prev"),w=document.querySelector(".next");let i=0,m=0,c=[];if(n&&g&&E&&l&&d&&L&&y&&p&&f&&h&&b.length>1&&v&&w){let _=function(e){return e.replace("square","large")},u=function(e,a){if(e>=0&&e<c.length){const t=c[e];if(a>=0&&a<t.photos.length){const o=t.photos[a].url;L.src=_(o);const r=t.species_guess||t.taxon?.preferred_common_name||t.taxon?.name||"Unknown Species";if(y&&(y.innerHTML=`${r}<br>Observed on: ${new Date(t.observed_on).toLocaleDateString()}`),p)if(t.taxon?.wikipedia_url){p.innerHTML=`<a href="#" class="wiki-link" data-url="${t.taxon.wikipedia_url}">Learn more on Wikipedia</a>`;const s=p.querySelector(".wiki-link");s&&s.addEventListener("click",x)}else p.innerHTML="";i=e,m=a,$(t)}}},$=function(e){f&&(f.innerHTML="",e.photos.forEach((a,t)=>{const o=document.createElement("img");o.src=a.url,o.alt=`Thumbnail ${t+1}`,o.className=t===m?"modal-thumbnail active":"modal-thumbnail",o.addEventListener("click",()=>u(i,t)),f.appendChild(o)}))},B=function(){const e=c[i];m<e.photos.length-1?u(i,m+1):i<c.length-1&&u(i+1,0)},H=function(){if(m>0)u(i,m-1);else if(i>0){const e=c[i-1];u(i-1,e.photos.length-1)}};const N=n.dataset.perPage||"5",T=n.dataset.taxonId,C=n.dataset.searchType||"general";async function I(e){if(!e.trim()){n&&(n.innerHTML="Please enter a search term.");return}n&&(n.innerHTML="Loading...");try{let a=`https://api.inaturalist.org/v1/observations?per_page=${N}&order=desc&order_by=created_at&photos=true`;T&&(a+=`&taxon_id=${T}`),C==="species"?a+=`&taxon_name=${encodeURIComponent(e)}`:a+=`&q=${encodeURIComponent(e)}`;const o=await(await fetch(a)).json();if(o.results.length===0){n&&(n.innerHTML="No results found.");return}c=o.results;const r=document.createElement("div");r.className="observation-grid",c.forEach((s,S)=>{const M=s.species_guess||s.taxon?.preferred_common_name||s.taxon?.name||"Unknown Species",k=document.createElement("div");k.className="observation-item";const D=s.photos[0]?.url||"";k.innerHTML=`
              <img src="${D}" alt="${M}" loading="lazy" class="thumbnail">
              <div class="observation-info">
                <h3>${M}</h3>
                <p>Observed on: ${new Date(s.observed_on).toLocaleDateString()}</p>
              </div>
            `,r.appendChild(k),k.querySelector(".thumbnail").addEventListener("click",()=>{l&&(l.style.display="block",u(S,0))})}),n&&(n.innerHTML="",n.appendChild(r))}catch(a){console.error("Error fetching iNaturalist data:",a),n&&(n.innerHTML="Error loading iNaturalist data. Please try again.")}}async function x(e){e.preventDefault();const t=e.target.dataset.url;if(t&&d&&h){h.innerHTML="Loading Wikipedia content...",d.style.display="block";try{const r=await(await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${t.split("/wiki/")[1]}`)).json();h.innerHTML=`
              <h2>${r.title}</h2>
              <p>${r.extract}</p>
              <a href="${t}" target="_blank" rel="noopener noreferrer">Read more on Wikipedia</a>
            `}catch(o){console.error("Error fetching Wikipedia content:",o),h.innerHTML="Error loading Wikipedia content. Please try again."}}}E.addEventListener("click",()=>{I(g.value)}),g.addEventListener("keypress",e=>{e.key==="Enter"&&I(g.value)}),Array.from(b).forEach(e=>{e.addEventListener("click",function(){l.style.display="none",d.style.display="none"})}),v.onclick=H,w.onclick=B,window.onclick=function(e){e.target==l&&(l.style.display="none"),e.target==d&&(d.style.display="none")}}else console.error("Could not find necessary elements for iNaturalist data")});

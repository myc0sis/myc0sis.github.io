document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("inaturalist-data"),u=document.getElementById("search-input"),g=document.getElementById("search-button"),r=document.getElementById("image-modal"),y=document.getElementById("modal-image"),f=document.getElementById("modal-caption"),p=document.getElementById("modal-thumbnails"),b=document.getElementsByClassName("close")[0],v=document.querySelector(".prev"),E=document.querySelector(".next");let a=0,i=0,c=[];if(t&&u&&g&&r&&y&&f&&p&&b&&v&&E){let _=function(e){return e.replace("square","large")},l=function(e,n){if(e>=0&&e<c.length){const o=c[e];if(n>=0&&n<o.photos.length){const s=o.photos[n].url;y.src=_(s);const d=o.species_guess||o.taxon?.preferred_common_name||o.taxon?.name||"Unknown Species";f&&(f.innerHTML=`${d}<br>Observed on: ${new Date(o.observed_on).toLocaleDateString()}`),a=e,i=n,k(o)}}},k=function(e){p&&(p.innerHTML="",e.photos.forEach((n,o)=>{const s=document.createElement("img");s.src=n.url,s.alt=`Thumbnail ${o+1}`,s.className=o===i?"modal-thumbnail active":"modal-thumbnail",s.addEventListener("click",()=>l(a,o)),p.appendChild(s)}))},B=function(){const e=c[a];i<e.photos.length-1?l(a,i+1):a<c.length-1&&l(a+1,0)},N=function(){if(i>0)l(a,i-1);else if(a>0){const e=c[a-1];l(a-1,e.photos.length-1)}};const w=t.dataset.perPage||"5",L=t.dataset.taxonId,$=t.dataset.searchType||"general";async function I(e){if(!e.trim()){t&&(t.innerHTML="Please enter a search term.");return}t&&(t.innerHTML="Loading...");try{let n=`https://api.inaturalist.org/v1/observations?per_page=${w}&order=desc&order_by=created_at`;L&&(n+=`&taxon_id=${L}`),$==="species"?n+=`&taxon_name=${encodeURIComponent(e)}`:n+=`&q=${encodeURIComponent(e)}`;const s=await(await fetch(n)).json();if(s.results.length===0){t&&(t.innerHTML="No results found.");return}c=s.results;const d=document.createElement("div");d.className="observation-grid",c.forEach((m,M)=>{const T=m.species_guess||m.taxon?.preferred_common_name||m.taxon?.name||"Unknown Species",h=document.createElement("div");h.className="observation-item";const C=m.photos[0]?.url||"";h.innerHTML=`
              <img src="${C}" alt="${T}" loading="lazy" class="thumbnail">
              <div class="observation-info">
                <h3>${T}</h3>
                <p>Observed on: ${new Date(m.observed_on).toLocaleDateString()}</p>
              </div>
            `,d.appendChild(h),h.querySelector(".thumbnail").addEventListener("click",()=>{r&&(r.style.display="block",l(M,0))})}),t&&(t.innerHTML="",t.appendChild(d))}catch(n){console.error("Error fetching iNaturalist data:",n),t&&(t.innerHTML="Error loading iNaturalist data. Please try again.")}}g.addEventListener("click",()=>{I(u.value)}),u.addEventListener("keypress",e=>{e.key==="Enter"&&I(u.value)}),b.onclick=function(){r&&(r.style.display="none")},v.onclick=N,E.onclick=B,window.onclick=function(e){e.target==r&&(r.style.display="none")}}else console.error("Could not find necessary elements for iNaturalist data")});
